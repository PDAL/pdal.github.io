


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing a writer &mdash; pdal.io</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/breathe.css" type="text/css" />
  

  
        <link rel="author" title="About these documents"
              href="../about.html"/>
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="pdal.io" href="../index.html"/>
        <link rel="up" title="Tutorials" href="index.html"/>
        <link rel="next" title="libLAS C API to PDAL transition guide" href="liblas_to_pdal.html"/>
        <link rel="prev" title="Writing a reader" href="writing-reader.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> PDAL
          

          
          </a>

          
            
            
              <div class="version">
                1.5.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../download.html">Download</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apps/index.html">Applications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../community.html">Community</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pipeline.html">Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stages/readers.html">Readers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stages/writers.html">Writers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stages/filters.html">Filters</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dimensions.html">Dimensions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python.html">Python</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#getting-started">Getting Started</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#using-pdal">Using PDAL</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#developing">Developing</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="writing-filter.html">Writing a filter</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing-kernel.html">Writing a kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="writing-reader.html">Writing a reader</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="#">Writing a writer</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#the-header">The header</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id1">The header</a></li>
<li class="toctree-l4"><a class="reference internal" href="#compiling-and-usage">Compiling and Usage</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="liblas_to_pdal.html">libLAS C API to PDAL transition guide</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../workshop/index.html">Workshop</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../development/index.html">Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">License</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">PDAL</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          





<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Home</a> &raquo;</li>
      
        <li><a href="index.html">Tutorials</a> &raquo;</li>
      
    <li>Writing a writer</li>
    <li class="wy-breadcrumbs-aside">
      
        
      
    </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-a-writer">
<span id="writing-writer"></span><h1>Writing a writer<a class="headerlink" href="#writing-a-writer" title="Permalink to this headline">¶</a></h1>
<table class="docutils field-list" frame="void" rules="none">
<col class="field-name" />
<col class="field-body" />
<tbody valign="top">
<tr class="field-odd field"><th class="field-name">Authors:</th><td class="field-body">Bradley Chambers, Scott Lewis</td>
</tr>
<tr class="field-even field"><th class="field-name">Contact:</th><td class="field-body"><a class="reference external" href="mailto:brad&#46;chambers&#37;&#52;&#48;gmail&#46;com">brad<span>&#46;</span>chambers<span>&#64;</span>gmail<span>&#46;</span>com</a></td>
</tr>
<tr class="field-odd field"><th class="field-name">Date:</th><td class="field-body">10/26/2016</td>
</tr>
</tbody>
</table>
<p>PDAL&#8217;s command-line application can be extended through the development of
writer functions. In this tutorial, we will give a brief example.</p>
<div class="section" id="the-header">
<h2>The header<a class="headerlink" href="#the-header" title="Permalink to this headline">¶</a></h2>
<p>First, we provide a full listing of the writer header.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// MyWriter.hpp</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">&lt;pdal/Writer.hpp&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">pdal</span><span class="p">{</span>

  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&gt;</span> <span class="n">FileStreamPtr</span><span class="p">;</span>

  <span class="k">class</span> <span class="nc">MyWriter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Writer</span>
  <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">MyWriter</span><span class="p">()</span>
    <span class="p">{}</span>

    <span class="k">static</span> <span class="kt">void</span>  <span class="o">*</span> <span class="n">create</span><span class="p">();</span>
    <span class="k">static</span> <span class="kt">int32_t</span> <span class="nf">destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getName</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="k">const</span> <span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_filename</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_newline</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_datafield</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_precision</span><span class="p">;</span>

    <span class="n">FileStreamPtr</span> <span class="n">m_stream</span><span class="p">;</span>
    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">m_dataDim</span><span class="p">;</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace pdal</span>
</pre></div>
</td></tr></table></div>
<p>In your MyWriter class, you will declare the necessary methods and variables
needed to make the writer work and meet the plugin specifications.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&gt;</span> <span class="n">FileStreamPtr</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>FileStreamPtr is defined to make the declaration of the stream easier to manage
later on.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span>    <span class="k">static</span> <span class="kt">void</span>  <span class="o">*</span> <span class="nf">create</span><span class="p">();</span>
    <span class="k">static</span> <span class="kt">int32_t</span> <span class="nf">destroy</span><span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">);</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getName</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>These three methods are required to fulfill the specs for defining a new plugin.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="k">const</span> <span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>
</pre></div>
</div>
<p>These methods are used during various phases of the pipeline.  There are also
more methods, which will not be covered in this tutorial.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_filename</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_newline</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_datafield</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_precision</span><span class="p">;</span>

    <span class="n">FileStreamPtr</span> <span class="n">m_stream</span><span class="p">;</span>
    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">m_dataDim</span><span class="p">;</span>
</pre></div>
</div>
<p>These are variables our Writer will use, such as the file to write to, the
newline character to use, the name of the data field to use to write the MyData
field, precision of the double outputs, the output stream, and the dimension
that corresponds to the data field for easier lookup.</p>
<p>As mentioned, there cen be additional configurations done as needed.</p>
</div>
<div class="section" id="id1">
<h2>The header<a class="headerlink" href="#id1" title="Permalink to this headline">¶</a></h2>
<p>We will start with a full listing of the writer source.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// MyWriter.cpp</span>

<span class="cp">#include</span> <span class="cpf">&quot;MyWriter.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pdal/pdal_macros.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pdal/util/FileUtils.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pdal/util/ProgramArgs.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">pdal</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="n">PluginInfo</span> <span class="k">const</span> <span class="n">s_info</span> <span class="o">=</span> <span class="n">PluginInfo</span><span class="p">(</span>
    <span class="s">&quot;writers.mywriter&quot;</span><span class="p">,</span>
    <span class="s">&quot;My Awesome Writer&quot;</span><span class="p">,</span>
    <span class="s">&quot;http://path/to/documentation&quot;</span> <span class="p">);</span>

  <span class="n">CREATE_SHARED_PLUGIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MyWriter</span><span class="p">,</span> <span class="n">Writer</span><span class="p">,</span> <span class="n">s_info</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">getName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">s_info</span><span class="p">.</span><span class="n">name</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">struct</span> <span class="n">FileStreamDeleter</span>
  <span class="p">{</span>
    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
        <span class="n">FileUtils</span><span class="o">::</span><span class="n">closeFile</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>


  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// setPositional() Makes the argument required.</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="s">&quot;Output filename&quot;</span><span class="p">,</span> <span class="n">m_filename</span><span class="p">).</span><span class="n">setPositional</span><span class="p">();</span>  
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;newline&quot;</span><span class="p">,</span> <span class="s">&quot;Line terminator&quot;</span><span class="p">,</span> <span class="n">m_newline</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;datafield&quot;</span><span class="p">,</span> <span class="s">&quot;Data field&quot;</span><span class="p">,</span> <span class="n">m_datafield</span><span class="p">,</span> <span class="s">&quot;UserData&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;precision&quot;</span><span class="p">,</span> <span class="s">&quot;Precision&quot;</span><span class="p">,</span> <span class="n">m_precision</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">initialize</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">m_stream</span> <span class="o">=</span> <span class="n">FileStreamPtr</span><span class="p">(</span><span class="n">FileUtils</span><span class="o">::</span><span class="n">createFile</span><span class="p">(</span><span class="n">m_filename</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
      <span class="n">FileStreamDeleter</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_stream</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">out</span><span class="p">;</span>
      <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;writers.mywriter couldn&#39;t open &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_filename</span> <span class="o">&lt;&lt;</span>
        <span class="s">&quot;&#39; for output.&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">(</span><span class="n">m_precision</span><span class="p">);</span>
    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">fixed</span><span class="p">;</span>

    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">d</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">layout</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">findDim</span><span class="p">(</span><span class="n">m_datafield</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Unknown</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">oss</span><span class="p">;</span>
      <span class="n">oss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Dimension not found with name &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_datafield</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">oss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">m_dataDim</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;#X:Y:Z:MyData&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">PointId</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">X</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">y</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Y</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">z</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Z</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">myData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_datafield</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">myData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_dataDim</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">z</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">myData</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>


  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">done</span><span class="p">(</span><span class="n">PointTableRef</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
  <span class="p">}</span>

<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>In the writer implementation, we will use a macro defined in pdal_macros,
which is included in the include chain we are using.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span>  <span class="k">static</span> <span class="n">PluginInfo</span> <span class="k">const</span> <span class="n">s_info</span> <span class="o">=</span> <span class="n">PluginInfo</span><span class="p">(</span>
    <span class="s">&quot;writers.mywriter&quot;</span><span class="p">,</span>
    <span class="s">&quot;My Awesome Writer&quot;</span><span class="p">,</span>
    <span class="s">&quot;http://path/to/documentation&quot;</span> <span class="p">);</span>

  <span class="n">CREATE_SHARED_PLUGIN</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">MyWriter</span><span class="p">,</span> <span class="n">Writer</span><span class="p">,</span> <span class="n">s_info</span><span class="p">);</span>
</pre></div>
</div>
<p>Here we define a struct with information regarding the writer, such as the
name, a description, and a path to documentation.  We then use the macro
to create a SHARED plugin, which means it will be external to the main PDAL
installation.  When using the macro, we specify the version (major and minor),
the class of the plugin, the class of the parent (Writer, in this case), and
the struct we defined earlier.</p>
<p>Creating STATIC plugins, which would be part of the main PDAL installation, is
also possible, but requires some extra steps and will not be covered here.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">struct</span> <span class="n">FileStreamDeleter</span>
  <span class="p">{</span>
    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
        <span class="n">FileUtils</span><span class="o">::</span><span class="n">closeFile</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
</pre></div>
</td></tr></table></div>
<p>This struct is used for helping with the FileStreamPtr for cleanup.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// setPositional() Makes the argument required.</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="s">&quot;Output filename&quot;</span><span class="p">,</span> <span class="n">m_filename</span><span class="p">).</span><span class="n">setPositional</span><span class="p">();</span>  
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;newline&quot;</span><span class="p">,</span> <span class="s">&quot;Line terminator&quot;</span><span class="p">,</span> <span class="n">m_newline</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;datafield&quot;</span><span class="p">,</span> <span class="s">&quot;Data field&quot;</span><span class="p">,</span> <span class="n">m_datafield</span><span class="p">,</span> <span class="s">&quot;UserData&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;precision&quot;</span><span class="p">,</span> <span class="s">&quot;Precision&quot;</span><span class="p">,</span> <span class="n">m_precision</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method defines the arguments the writer provides and binds them to
private variables.</p>
<div class="highlight-cpp"><div class="highlight"><pre><span></span>    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">out</span><span class="p">;</span>
      <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;writers.mywriter couldn&#39;t open &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_filename</span> <span class="o">&lt;&lt;</span>
        <span class="s">&quot;&#39; for output.&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">(</span><span class="n">m_precision</span><span class="p">);</span>
    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">fixed</span><span class="p">;</span>

    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">d</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">layout</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">findDim</span><span class="p">(</span><span class="n">m_datafield</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Unknown</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">oss</span><span class="p">;</span>
</pre></div>
</div>
<p>This method initializes our file stream in preparation for writing.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">(</span><span class="n">m_precision</span><span class="p">);</span>
    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">fixed</span><span class="p">;</span>

    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">d</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">layout</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">findDim</span><span class="p">(</span><span class="n">m_datafield</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Unknown</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">oss</span><span class="p">;</span>
      <span class="n">oss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Dimension not found with name &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_datafield</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">oss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">m_dataDim</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;#X:Y:Z:MyData&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>The ready method is used to prepare the writer for any number of PointViews that
may be passed in.  In this case, we are setting the precision for our double
writes, looking up the dimension specified as the one to write into MyData,
and writing the header of the output file.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">PointId</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">X</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">y</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Y</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">z</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Z</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">myData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_datafield</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">myData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_dataDim</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">z</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">myData</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method is the main method for writing.  In our case, we are writing a very
simple file, with data in the format of X:Y:Z:MyData.  We loop through each
index in the PointView, and for each one we take the X, Y, and Z values, as well
as the value for the specified MyData dimension, and write this to the output
file.   In particular, note the reading of MyData; in our case, MyData is an
integer, but the field we are reading might be a double.  Converting from double
to integer is done via truncation, not rounding, so by adding .5 before making
the conversion will ensure rounding is done properly.</p>
<p>Note that in this case, the output format is pretty simple.  For more complex
outputs, you may need to generate helper methods (and possibly helper classes)
to help generate the proper output.  The key is reading in the appropriate
values from the PointView, and then writing those in whatever necessary format
to the output stream.</p>
<div class="highlight-cpp"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">done</span><span class="p">(</span><span class="n">PointTableRef</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method is called when the writing is done.  In this case, it simply cleans
up the output stream by resetting it.</p>
</div>
<div class="section" id="compiling-and-usage">
<h2>Compiling and Usage<a class="headerlink" href="#compiling-and-usage" title="Permalink to this headline">¶</a></h2>
<p>To compile this reader, we will use cmake.  Here is the CMakeLists.txt file we
will use for this process:</p>
<div class="highlight-default"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span>cmake_minimum_required(VERSION 2.8.12)
project(WriterTutorial)

find_package(PDAL 1.0.0 REQUIRED CONFIG)

set(CMAKE_CXX_FLAGS &quot;-std=c++11&quot;)
add_library(pdal_plugin_writer_mywriter SHARED MyWriter.cpp)
target_link_libraries(pdal_plugin_writer_mywriter PRIVATE ${PDAL_LIBRARIES})
target_include_directories(pdal_plugin_writer_mywriter PRIVATE
    ${PDAL_INCLUDE_DIRS})
</pre></div>
</td></tr></table></div>
<p>If this file is in the directory with the MyWriter.hpp and MyWriter.cpp files,
simply run <code class="docutils literal"><span class="pre">cmake</span> <span class="pre">.</span></code> followed by <code class="docutils literal"><span class="pre">make</span></code>.  This will generate a file called
<code class="docutils literal"><span class="pre">libpdal_plugin_writer_mywriter.dylib</span></code>.</p>
<p>Put this dylib file into the directory pointed to by <code class="docutils literal"><span class="pre">PDAL_DRIVER_PATH</span></code>, and
then when you run <code class="docutils literal"><span class="pre">pdal</span> <span class="pre">--drivers</span></code>, you will see an entry for
writers.mywriter.</p>
<p>To test the writer, we will put it into a pipeline and read in a LAS file and
covert it to our output format.  For this example, use <a class="reference external" href="https://github.com/PDAL/PDAL/blob/master/test/data/interesting.las?raw=true">interesting.las</a>, and
run it through <a class="reference external" href="https://github.com/PDAL/PDAL/blob/master/examples/writing-writer/pipeline-mywriter.json?raw=true">pipeline-mywriter.json</a>.</p>
<p>If those files are in the same directory, you would just run the command
<code class="docutils literal"><span class="pre">pdal</span> <span class="pre">pipeline</span> <span class="pre">pipeline-mywriter.json</span></code>, and it will generate an output file
called output.txt, which will be in the proper format.  From there, if you
wanted, you could run that output file through the MyReader that was created
in the previous tutorial, as well.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="liblas_to_pdal.html" class="btn btn-neutral float-right" title="libLAS C API to PDAL transition guide" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="writing-reader.html" class="btn btn-neutral" title="Writing a reader" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
                    &copy;  2017
                        <a href="http://github.com/hobu">Howard Butler</a>,
                        <a href="http://github.com/mpgerlek">Michael Gerlek</a>,
                        and
                        <a href="https://github.com/PDAL/PDAL/graphs/contributors">others</a>.
      Last updated on Apr 21, 2017.

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.5.0',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.0/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
  
    <div class="footer">
        <div class="container">
                    &copy;  2017
                        <a href="http://github.com/hobu">Howard Butler</a>,
                        <a href="http://github.com/mpgerlek">Michael Gerlek</a>,
                        and
                        <a href="https://github.com/PDAL/PDAL/graphs/contributors">others</a>,
                Last updated
                    on Apr 21, 2017.
        </div>
    </div>

</body>
</html>