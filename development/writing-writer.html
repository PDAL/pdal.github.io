


<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Writing a writer &mdash; pdal.io</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  
  
  
    <link rel="canonical" href="https://pdal.io/development/writing-writer.html"/>
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script async="async" type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/pdal.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/breathe.css" type="text/css" />
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="next" title="CMake" href="cmake.html" />
    <link rel="prev" title="Writing a reader" href="writing-reader.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> PDAL
          

          
          </a>

          
            
            
              <div class="version">
                2.1.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">About</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../download.html">Download</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quickstart</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../apps/index.html">Applications</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../community.html">Community</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../pipeline.html">Pipeline</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stages/readers.html">Readers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stages/writers.html">Writers</a></li>
<li class="toctree-l1"><a class="reference internal" href="../stages/filters.html">Filters</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../dimensions.html">Dimensions</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../types.html">Types</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../python.html">Python</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../java.html">Java</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorial/index.html">Tutorials</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../workshop/index.html">Workshop</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Development</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="overview.html">PDAL Architecture Overview</a></li>
<li class="toctree-l2"><a class="reference internal" href="compilation/index.html">Compilation</a></li>
<li class="toctree-l2"><a class="reference internal" href="errorhandling.html">Errors and Error Handling</a></li>
<li class="toctree-l2"><a class="reference internal" href="metadata.html">Metadata</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing.html">Writing with PDAL</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-filter.html">Writing a filter</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-kernel.html">Writing a kernel</a></li>
<li class="toctree-l2"><a class="reference internal" href="writing-reader.html">Writing a reader</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Writing a writer</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#the-header">The header</a></li>
<li class="toctree-l3"><a class="reference internal" href="#the-source">The source</a></li>
<li class="toctree-l3"><a class="reference internal" href="#compiling-and-usage">Compiling and Usage</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="cmake.html">CMake</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../project/index.html">Project</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/index.html">API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../copyright.html">License</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../references.html">References</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">PDAL</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html"> Documentation </a> &raquo;</li>
      
          <li><a href="index.html">Development</a> &raquo;</li>
      
      <li>Writing a writer</li>
    

    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/PDAL/PDAL/edit//master/doc/development/writing-writer.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <div class="rst-breadcrumbs-buttons" role="navigation" aria-label="breadcrumb navigation">
      
        <a href="cmake.html" class="btn btn-neutral float-right" title="CMake" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="writing-reader.html" class="btn btn-neutral float-left" title="Writing a reader" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
  </div>
  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="writing-a-writer">
<span id="writing-writer"></span><h1>Writing a writer<a class="headerlink" href="#writing-a-writer" title="Permalink to this headline">¶</a></h1>
<dl class="field-list simple">
<dt class="field-odd">Authors</dt>
<dd class="field-odd"><p>Bradley Chambers, Scott Lewis</p>
</dd>
<dt class="field-even">Contact</dt>
<dd class="field-even"><p><a class="reference external" href="mailto:brad&#46;chambers&#37;&#52;&#48;gmail&#46;com">brad<span>&#46;</span>chambers<span>&#64;</span>gmail<span>&#46;</span>com</a></p>
</dd>
<dt class="field-odd">Date</dt>
<dd class="field-odd"><p>10/26/2016</p>
</dd>
</dl>
<p>PDAL’s command-line application can be extended through the development of
writer functions. In this tutorial, we will give a brief example.</p>
<div class="section" id="the-header">
<h2>The header<a class="headerlink" href="#the-header" title="Permalink to this headline">¶</a></h2>
<p>First, we provide a full listing of the writer header.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// MyWriter.hpp</span>

<span class="cp">#pragma once</span>

<span class="cp">#include</span> <span class="cpf">&lt;pdal/Writer.hpp&gt;</span><span class="cp"></span>

<span class="cp">#include</span> <span class="cpf">&lt;string&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">pdal</span><span class="p">{</span>

  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&gt;</span> <span class="n">FileStreamPtr</span><span class="p">;</span>

  <span class="k">class</span> <span class="nc">MyWriter</span> <span class="o">:</span> <span class="k">public</span> <span class="n">Writer</span>
  <span class="p">{</span>
  <span class="k">public</span><span class="o">:</span>
    <span class="n">MyWriter</span><span class="p">()</span>
    <span class="p">{}</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getName</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>

  <span class="k">private</span><span class="o">:</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="n">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="k">const</span> <span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>

    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_filename</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_newline</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_datafield</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_precision</span><span class="p">;</span>

    <span class="n">FileStreamPtr</span> <span class="n">m_stream</span><span class="p">;</span>
    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">m_dataDim</span><span class="p">;</span>
  <span class="p">};</span>

<span class="p">}</span> <span class="c1">// namespace pdal</span>
</pre></div>
</td></tr></table></div>
<p>In your MyWriter class, you will declare the necessary methods and variables
needed to make the writer work and meet the plugin specifications.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">typedef</span> <span class="n">std</span><span class="o">::</span><span class="n">shared_ptr</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">ostream</span><span class="o">&gt;</span> <span class="n">FileStreamPtr</span><span class="p">;</span>
</pre></div>
</td></tr></table></div>
<p>FileStreamPtr is defined to make the declaration of the stream easier to manage
later on.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">getName</span><span class="p">()</span> <span class="k">const</span><span class="p">;</span>
</pre></div>
</div>
<p>Every stage must return a unique name.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">initialize</span><span class="p">();</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">write</span><span class="p">(</span><span class="k">const</span> <span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">);</span>
    <span class="k">virtual</span> <span class="kt">void</span> <span class="nf">done</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">);</span>
</pre></div>
</div>
<p>These methods are used during various phases of the pipeline.  There are also
more methods, which will not be covered in this tutorial.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_filename</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_newline</span><span class="p">;</span>
    <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">m_datafield</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">m_precision</span><span class="p">;</span>

    <span class="n">FileStreamPtr</span> <span class="n">m_stream</span><span class="p">;</span>
    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">m_dataDim</span><span class="p">;</span>
</pre></div>
</div>
<p>These are variables our Writer will use, such as the file to write to, the
newline character to use, the name of the data field to use to write the MyData
field, precision of the double outputs, the output stream, and the dimension
that corresponds to the data field for easier lookup.</p>
<p>As mentioned, there cen be additional configurations done as needed.</p>
</div>
<div class="section" id="the-source">
<h2>The source<a class="headerlink" href="#the-source" title="Permalink to this headline">¶</a></h2>
<p>We will start with a full listing of the writer source.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="c1">// MyWriter.cpp</span>

<span class="cp">#include</span> <span class="cpf">&quot;MyWriter.hpp&quot;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pdal/util/FileUtils.hpp&gt;</span><span class="cp"></span>
<span class="cp">#include</span> <span class="cpf">&lt;pdal/util/ProgramArgs.hpp&gt;</span><span class="cp"></span>

<span class="k">namespace</span> <span class="n">pdal</span>
<span class="p">{</span>
  <span class="k">static</span> <span class="n">PluginInfo</span> <span class="k">const</span> <span class="n">s_info</span>
  <span class="p">{</span>
    <span class="s">&quot;writers.mywriter&quot;</span><span class="p">,</span>
    <span class="s">&quot;My Awesome Writer&quot;</span><span class="p">,</span>
    <span class="s">&quot;http://path/to/documentation&quot;</span>
  <span class="p">};</span>

  <span class="n">CREATE_SHARED_STAGE</span><span class="p">(</span><span class="n">MyWriter</span><span class="p">,</span> <span class="n">s_info</span><span class="p">);</span>

  <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">getName</span><span class="p">()</span> <span class="k">const</span> <span class="p">{</span> <span class="k">return</span> <span class="n">s_info</span><span class="p">.</span><span class="n">name</span><span class="p">;</span> <span class="p">}</span>

  <span class="k">struct</span> <span class="n">FileStreamDeleter</span>
  <span class="p">{</span>
    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
        <span class="n">FileUtils</span><span class="o">::</span><span class="n">closeFile</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>

  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// setPositional() Makes the argument required.</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="s">&quot;Output filename&quot;</span><span class="p">,</span> <span class="n">m_filename</span><span class="p">).</span><span class="n">setPositional</span><span class="p">();</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;newline&quot;</span><span class="p">,</span> <span class="s">&quot;Line terminator&quot;</span><span class="p">,</span> <span class="n">m_newline</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;datafield&quot;</span><span class="p">,</span> <span class="s">&quot;Data field&quot;</span><span class="p">,</span> <span class="n">m_datafield</span><span class="p">,</span> <span class="s">&quot;UserData&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;precision&quot;</span><span class="p">,</span> <span class="s">&quot;Precision&quot;</span><span class="p">,</span> <span class="n">m_precision</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>

  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">initialize</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">m_stream</span> <span class="o">=</span> <span class="n">FileStreamPtr</span><span class="p">(</span><span class="n">FileUtils</span><span class="o">::</span><span class="n">createFile</span><span class="p">(</span><span class="n">m_filename</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
      <span class="n">FileStreamDeleter</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_stream</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">out</span><span class="p">;</span>
      <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;writers.mywriter couldn&#39;t open &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_filename</span> <span class="o">&lt;&lt;</span>
        <span class="s">&quot;&#39; for output.&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>


  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">(</span><span class="n">m_precision</span><span class="p">);</span>
    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">fixed</span><span class="p">;</span>

    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">d</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">layout</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">findDim</span><span class="p">(</span><span class="n">m_datafield</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Unknown</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">oss</span><span class="p">;</span>
      <span class="n">oss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Dimension not found with name &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_datafield</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">oss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">m_dataDim</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;#X:Y:Z:MyData&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
  <span class="p">}</span>


  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">PointId</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">X</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">y</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Y</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">z</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Z</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">myData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_datafield</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">myData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_dataDim</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">z</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">myData</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>


  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">done</span><span class="p">(</span><span class="n">PointTableRef</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>In the writer implementation, we will use a macro defined in pdal_macros,
which is included in the include chain we are using.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="k">static</span> <span class="n">PluginInfo</span> <span class="k">const</span> <span class="n">s_info</span>
  <span class="p">{</span>
    <span class="s">&quot;writers.mywriter&quot;</span><span class="p">,</span>
    <span class="s">&quot;My Awesome Writer&quot;</span><span class="p">,</span>
    <span class="s">&quot;http://path/to/documentation&quot;</span>
  <span class="p">};</span>

  <span class="n">CREATE_SHARED_STAGE</span><span class="p">(</span><span class="n">MyWriter</span><span class="p">,</span> <span class="n">s_info</span><span class="p">);</span>
</pre></div>
</div>
<p>Here we define a struct with information regarding the writer, such as the
name, a description, and a path to documentation.  We then use the macro
to create a SHARED stage, which means it will be external to the main PDAL
installation.  When using the macro, we specify the name of the Stage and
the PluginInfo struct we defined earlier.</p>
<p>When making a shared plugin, the name of the shared library must
correspond with the name of the writer
provided here.  The name of the generated shared object must be</p>
<dl class="simple">
<dt>::</dt><dd><p>libpdal_plugin_writer_&lt;writer name&gt;.&lt;shared library extension&gt;</p>
</dd>
</dl>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="k">struct</span> <span class="n">FileStreamDeleter</span>
  <span class="p">{</span>
    <span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">T</span><span class="o">&gt;</span>
    <span class="kt">void</span> <span class="k">operator</span><span class="p">()(</span><span class="n">T</span><span class="o">*</span> <span class="n">ptr</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">ptr</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="n">ptr</span><span class="o">-&gt;</span><span class="n">flush</span><span class="p">();</span>
        <span class="n">FileUtils</span><span class="o">::</span><span class="n">closeFile</span><span class="p">(</span><span class="n">ptr</span><span class="p">);</span>
      <span class="p">}</span>
    <span class="p">}</span>
  <span class="p">};</span>
</pre></div>
</td></tr></table></div>
<p>This struct is used for helping with the FileStreamPtr for cleanup.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4
5
6
7
8</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">addArgs</span><span class="p">(</span><span class="n">ProgramArgs</span><span class="o">&amp;</span> <span class="n">args</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="c1">// setPositional() Makes the argument required.</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;filename&quot;</span><span class="p">,</span> <span class="s">&quot;Output filename&quot;</span><span class="p">,</span> <span class="n">m_filename</span><span class="p">).</span><span class="n">setPositional</span><span class="p">();</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;newline&quot;</span><span class="p">,</span> <span class="s">&quot;Line terminator&quot;</span><span class="p">,</span> <span class="n">m_newline</span><span class="p">,</span> <span class="s">&quot;</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;datafield&quot;</span><span class="p">,</span> <span class="s">&quot;Data field&quot;</span><span class="p">,</span> <span class="n">m_datafield</span><span class="p">,</span> <span class="s">&quot;UserData&quot;</span><span class="p">);</span>
    <span class="n">args</span><span class="p">.</span><span class="n">add</span><span class="p">(</span><span class="s">&quot;precision&quot;</span><span class="p">,</span> <span class="s">&quot;Precision&quot;</span><span class="p">,</span> <span class="n">m_precision</span><span class="p">,</span> <span class="mi">3</span><span class="p">);</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method defines the arguments the writer provides and binds them to
private variables.</p>
<div class="highlight-cpp notranslate"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">initialize</span><span class="p">()</span>
  <span class="p">{</span>
    <span class="n">m_stream</span> <span class="o">=</span> <span class="n">FileStreamPtr</span><span class="p">(</span><span class="n">FileUtils</span><span class="o">::</span><span class="n">createFile</span><span class="p">(</span><span class="n">m_filename</span><span class="p">,</span> <span class="nb">true</span><span class="p">),</span>
      <span class="n">FileStreamDeleter</span><span class="p">());</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_stream</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">stringstream</span> <span class="n">out</span><span class="p">;</span>
      <span class="n">out</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;writers.mywriter couldn&#39;t open &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_filename</span> <span class="o">&lt;&lt;</span>
        <span class="s">&quot;&#39; for output.&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
<p>This method initializes our file stream in preparation for writing.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">ready</span><span class="p">(</span><span class="n">PointTableRef</span> <span class="n">table</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="o">-&gt;</span><span class="n">precision</span><span class="p">(</span><span class="n">m_precision</span><span class="p">);</span>
    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">std</span><span class="o">::</span><span class="n">fixed</span><span class="p">;</span>

    <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span> <span class="n">d</span> <span class="o">=</span> <span class="n">table</span><span class="p">.</span><span class="n">layout</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">findDim</span><span class="p">(</span><span class="n">m_datafield</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">d</span> <span class="o">==</span> <span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Unknown</span><span class="p">)</span>
    <span class="p">{</span>
      <span class="n">std</span><span class="o">::</span><span class="n">ostringstream</span> <span class="n">oss</span><span class="p">;</span>
      <span class="n">oss</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;Dimension not found with name &#39;&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_datafield</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;&#39;&quot;</span><span class="p">;</span>
      <span class="k">throw</span> <span class="nf">pdal_error</span><span class="p">(</span><span class="n">oss</span><span class="p">.</span><span class="n">str</span><span class="p">());</span>
    <span class="p">}</span>

    <span class="n">m_dataDim</span> <span class="o">=</span> <span class="n">d</span><span class="p">;</span>

    <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;#X:Y:Z:MyData&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>The ready method is used to prepare the writer for any number of PointViews that
may be passed in.  In this case, we are setting the precision for our double
writes, looking up the dimension specified as the one to write into MyData,
and writing the header of the output file.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">write</span><span class="p">(</span><span class="n">PointViewPtr</span> <span class="n">view</span><span class="p">)</span>
  <span class="p">{</span>
      <span class="k">for</span> <span class="p">(</span><span class="n">PointId</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">idx</span><span class="p">)</span>
      <span class="p">{</span>
        <span class="kt">double</span> <span class="n">x</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">X</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">y</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Y</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">double</span> <span class="n">z</span> <span class="o">=</span> <span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">Dimension</span><span class="o">::</span><span class="n">Id</span><span class="o">::</span><span class="n">Z</span><span class="p">,</span> <span class="n">idx</span><span class="p">);</span>
        <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">myData</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">m_datafield</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
          <span class="n">myData</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)(</span><span class="n">view</span><span class="o">-&gt;</span><span class="n">getFieldAs</span><span class="o">&lt;</span><span class="kt">double</span><span class="o">&gt;</span><span class="p">(</span><span class="n">m_dataDim</span><span class="p">,</span> <span class="n">idx</span><span class="p">)</span> <span class="o">+</span> <span class="mf">0.5</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="o">*</span><span class="n">m_stream</span> <span class="o">&lt;&lt;</span> <span class="n">x</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">y</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span> <span class="o">&lt;&lt;</span> <span class="n">z</span> <span class="o">&lt;&lt;</span> <span class="s">&quot;:&quot;</span>
          <span class="o">&lt;&lt;</span> <span class="n">myData</span> <span class="o">&lt;&lt;</span> <span class="n">m_newline</span><span class="p">;</span>
      <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method is the main method for writing.  In our case, we are writing a very
simple file, with data in the format of X:Y:Z:MyData.  We loop through each
index in the PointView, and for each one we take the X, Y, and Z values, as well
as the value for the specified MyData dimension, and write this to the output
file.   In particular, note the reading of MyData; in our case, MyData is an
integer, but the field we are reading might be a double.  Converting from double
to integer is done via truncation, not rounding, so by adding .5 before making
the conversion will ensure rounding is done properly.</p>
<p>Note that in this case, the output format is pretty simple.  For more complex
outputs, you may need to generate helper methods (and possibly helper classes)
to help generate the proper output.  The key is reading in the appropriate
values from the PointView, and then writing those in whatever necessary format
to the output stream.</p>
<div class="highlight-cpp notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span>  <span class="kt">void</span> <span class="n">MyWriter</span><span class="o">::</span><span class="n">done</span><span class="p">(</span><span class="n">PointTableRef</span><span class="p">)</span>
  <span class="p">{</span>
    <span class="n">m_stream</span><span class="p">.</span><span class="n">reset</span><span class="p">();</span>
  <span class="p">}</span>
</pre></div>
</td></tr></table></div>
<p>This method is called when the writing is done.  In this case, it simply cleans
up the output stream by resetting it.</p>
</div>
<div class="section" id="compiling-and-usage">
<h2>Compiling and Usage<a class="headerlink" href="#compiling-and-usage" title="Permalink to this headline">¶</a></h2>
<p>To compile this reader, we will use cmake.  Here is the CMakeLists.txt file we
will use for this process:</p>
<div class="highlight-default notranslate"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13</pre></div></td><td class="code"><div class="highlight"><pre><span></span>cmake_minimum_required(VERSION 2.8.12)
project(WriterTutorial)

find_package(PDAL 2.0.0 REQUIRED CONFIG)
set(CMAKE_CXX_STANDARD 11)
set(CMAKE_CXX_STANDARD_REQUIRED ON)

add_library(pdal_plugin_writer_mywriter SHARED MyWriter.cpp)
target_link_libraries(pdal_plugin_writer_mywriter PRIVATE ${PDAL_LIBRARIES})

target_link_directories(pdal_plugin_writer_mywriter PRIVATE ${PDAL_LIBRARY_DIRS})
target_include_directories(pdal_plugin_writer_mywriter PRIVATE
    ${PDAL_INCLUDE_DIRS})
</pre></div>
</td></tr></table></div>
<p>If this file is in the directory with the MyWriter.hpp and MyWriter.cpp files,
simply run <code class="docutils literal notranslate"><span class="pre">cmake</span> <span class="pre">.</span></code> followed by <code class="docutils literal notranslate"><span class="pre">make</span></code>.  This will generate a file called
<code class="docutils literal notranslate"><span class="pre">libpdal_plugin_writer_mywriter.dylib</span></code>.</p>
<p>Put this dylib file into the directory pointed to by <code class="docutils literal notranslate"><span class="pre">PDAL_DRIVER_PATH</span></code>, and
then when you run <code class="docutils literal notranslate"><span class="pre">pdal</span> <span class="pre">--drivers</span></code>, you will see an entry for
writers.mywriter.</p>
<p>To test the writer, we will put it into a pipeline and read in a LAS file and
covert it to our output format.  For this example, use <a class="reference external" href="https://github.com/PDAL/PDAL/blob/master/test/data/interesting.las?raw=true">interesting.las</a>, and
run it through <a class="reference external" href="https://github.com/PDAL/PDAL/blob/master/examples/writing-writer/pipeline-mywriter.json?raw=true">pipeline-mywriter.json</a>.</p>
<p>If those files are in the same directory, you would just run the command
<code class="docutils literal notranslate"><span class="pre">pdal</span> <span class="pre">pipeline</span> <span class="pre">pipeline-mywriter.json</span></code>, and it will generate an output file
called output.txt, which will be in the proper format.  From there, if you
wanted, you could run that output file through the MyReader that was created
in the previous tutorial, as well.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="cmake.html" class="btn btn-neutral float-right" title="CMake" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="writing-reader.html" class="btn btn-neutral float-left" title="Writing a reader" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <div class="info">
      <a class="logo-link" href="https://hobu.co">
        <div class="hobu-logo"></div>
      </a>
      <div class="copyright">
      

                    &copy;  2020
                        <a href="https://github.com/abellgithub">Andrew Bell</a>,
                        <a href="https://github.com/chambbj">Brad Chambers</a>,
                        <a href="http://github.com/hobu">Howard Butler</a>,
                        and
                        <a href="https://github.com/PDAL/PDAL/graphs/contributors">others</a>.

      
      Last updated on Apr 10, 2020.
      </div>
    </div>
</footer>
        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
  
    <div class="footer">
        <div class="container">
                    &copy;  2020
                        <a href="http://github.com/hobu">Howard Butler</a>,
                        <a href="http://github.com/mpgerlek">Michael Gerlek</a>,
                        and
                        <a href="https://github.com/PDAL/PDAL/graphs/contributors">others</a>,
                Last updated
                    on Apr 10, 2020.
        </div>
    </div>

</body>
</html>